<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>‰ΩçÁΩÆÂõ∫ÂÆöAR„Éù„Çπ„Çø„Éº</title>
  <style>
    body { 
      margin: 0; 
      overflow: hidden;
      font-family: sans-serif;
    }
    #video-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    #camera-feed {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #poster-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 2;
      display: none;
    }
    #poster-image {
      max-width: 80vw;
      max-height: 60vh;
      box-shadow: 0 0 30px rgba(255,255,0,0.8);
      border: 4px solid #FFFF00;
      border-radius: 10px;
    }
    #poster-info {
      position: absolute;
      top: -50px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,200,0,0.95);
      color: #000;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 24px;
      font-weight: bold;
      white-space: nowrap;
    }
    #info {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 12px;
      border-radius: 8px;
      z-index: 1000;
      font-size: 12px;
      max-width: 300px;
    }
    #distance-info {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      z-index: 1000;
      font-size: 16px;
      text-align: center;
    }
    #start-button {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px 40px;
      font-size: 18px;
      background: #007AFF;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      z-index: 2000;
    }
    .status { margin: 3px 0; }
    .ok { color: #0f0; }
    .highlight { color: #ff0; font-weight: bold; }
    .distance { font-size: 20px; color: #0ff; font-weight: bold; }
  </style>
</head>
<body>
  
  <button id="start-button">AR„ÇíÈñãÂßã</button>
  
  <div id="video-container">
    <video id="camera-feed" autoplay playsinline></video>
  </div>
  
  <div id="poster-container">
    <div id="poster-info">„Éù„Çπ„Çø„Éº --</div>
    <img id="poster-image" src="poster.jpg" alt="Poster">
  </div>
  
  <div id="info">
    <div class="status">üìç GPS: <span id="gps-status">ÂæÖÊ©ü‰∏≠</span></div>
    <div class="status">ÁèæÂú®‰ΩçÁΩÆ: <span id="current-pos">--</span></div>
    <div class="status">Êõ¥Êñ∞: <span id="update-count">0</span>Âõû</div>
  </div>

  <div id="distance-info">
    <div style="margin-bottom: 5px;">ÊúÄÂØÑ„Çä„Éù„Çπ„Çø„Éº</div>
    <div><span id="nearest-id" class="highlight">--</span></div>
    <div class="distance"><span id="nearest-distance">--</span>m</div>
    <div style="font-size: 12px; margin-top: 5px;">
      <span id="visibility-status">ÁØÑÂõ≤Â§ñ</span>
    </div>
  </div>

  <script>
    const posters = [
      {id: 1, lat: 35.720533, lon: 139.762619},
      {id: 2, lat: 35.720446, lon: 139.763486},
      {id: 3, lat: 35.720987, lon: 139.764194},
      {id: 4, lat: 35.720798, lon: 139.764362},
      {id: 5, lat: 35.720655, lon: 139.764665},
      {id: 6, lat: 35.720462, lon: 139.765279},
      {id: 7, lat: 35.720311, lon: 139.765584},
      {id: 8, lat: 35.720145, lon: 139.765950},
      {id: 9, lat: 35.719991, lon: 139.766207},
      {id: 10, lat: 35.719865, lon: 139.766525},
      {id: 11, lat: 35.719580, lon: 139.766698}
    ];

    let userLat = null;
    let userLon = null;
    let updateCount = 0;
    let currentPoster = null;
    
    // Ë°®Á§∫Ë∑ùÈõ¢„ÅÆÈñæÂÄ§ÔºàÂ∫¶Ôºâ
    const DISPLAY_THRESHOLD = 0.0003; // Á¥Ñ30m‰ª•ÂÜÖ
    
    // Â∫¶Êï∞„Åß„ÅÆË∑ùÈõ¢Ë®àÁÆó
    function calculateDistanceDegree(lat1, lon1, lat2, lon2) {
      const dLat = lat2 - lat1;
      const dLon = lon2 - lon1;
      return Math.sqrt(dLat * dLat + dLon * dLon);
    }
    
    // Â∫¶„Çí„É°„Éº„Éà„É´„Å´Â§âÊèõÔºàÊ¶ÇÁÆóÔºâ
    function degreeToMeter(degree) {
      return degree * 100000; // ÂåóÁ∑Ø35Â∫¶‰ªòËøë„Åß„ÅÆÊ¶ÇÁÆó
    }

    document.getElementById('start-button').addEventListener('click', async () => {
      document.getElementById('start-button').style.display = 'none';
      await startAR();
    });

    async function startAR() {
      // „Ç´„É°„É©Ëµ∑Âãï
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: 1280, height: 720 }
        });
        const video = document.getElementById('camera-feed');
        video.srcObject = stream;
        console.log('‚úì „Ç´„É°„É©Ëµ∑Âãï');
      } catch (err) {
        alert('„Ç´„É°„É©„Ç®„É©„Éº: ' + err.message);
        return;
      }

      // GPS‰ΩçÁΩÆÊÉÖÂ†±„ÅÆÁõ£Ë¶ñ
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition((position) => {
          userLat = position.coords.latitude;
          userLon = position.coords.longitude;
          updateCount++;
          
          document.getElementById('gps-status').innerHTML = '<span class="ok">ÂèñÂæó‰∏≠</span>';
          document.getElementById('current-pos').textContent = 
            `${userLat.toFixed(6)}, ${userLon.toFixed(6)}`;
          document.getElementById('update-count').textContent = updateCount;
          
          updatePosterDisplay();
        }, (err) => {
          document.getElementById('gps-status').innerHTML = `<span style="color:#f00;">„Ç®„É©„Éº</span>`;
          console.error('GPS error:', err);
        }, { 
          enableHighAccuracy: true, 
          maximumAge: 0,
          timeout: 5000
        });
      } else {
        alert('„Åì„ÅÆ„Éá„Éê„Ç§„Çπ„ÅØGPS„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì');
      }
    }

    function updatePosterDisplay() {
      if (!userLat || !userLon) return;

      let nearest = null;
      let minDistance = Infinity;

      // ÊúÄÂØÑ„Çä„ÅÆ„Éù„Çπ„Çø„Éº„ÇíÊé¢„Åô
      posters.forEach(poster => {
        const distanceDeg = calculateDistanceDegree(userLat, userLon, poster.lat, poster.lon);
        if (distanceDeg < minDistance) {
          minDistance = distanceDeg;
          nearest = poster;
        }
      });

      if (nearest) {
        const distanceM = degreeToMeter(minDistance);
        
        // ÊúÄÂØÑ„ÇäÊÉÖÂ†±„ÇíÊõ¥Êñ∞
        document.getElementById('nearest-id').textContent = `„Éù„Çπ„Çø„Éº${nearest.id}`;
        document.getElementById('nearest-distance').textContent = distanceM.toFixed(1);

        // Ë°®Á§∫Ë∑ùÈõ¢ÂÜÖ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        if (minDistance < DISPLAY_THRESHOLD) {
          // „Éù„Çπ„Çø„Éº„ÇíË°®Á§∫
          showPoster(nearest);
          document.getElementById('visibility-status').innerHTML = 
            '<span style="color:#0f0;">‚úì Ë°®Á§∫‰∏≠</span>';
        } else {
          // „Éù„Çπ„Çø„Éº„ÇíÈùûË°®Á§∫
          hidePoster();
          document.getElementById('visibility-status').innerHTML = 
            `<span style="color:#ff0;">„ÇÇ„ÅÜÂ∞ë„ÅóËøë„Å•„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ (30m‰ª•ÂÜÖ)</span>`;
        }
      }
    }

    function showPoster(poster) {
      const container = document.getElementById('poster-container');
      const info = document.getElementById('poster-info');
      
      if (currentPoster !== poster.id) {
        currentPoster = poster.id;
        info.textContent = `„Éù„Çπ„Çø„Éº ${poster.id}`;
        console.log(`„Éù„Çπ„Çø„Éº${poster.id}„ÇíË°®Á§∫`);
      }
      
      container.style.display = 'block';
    }

    function hidePoster() {
      const container = document.getElementById('poster-container');
      container.style.display = 'none';
      currentPoster = null;
    }
  </script>
</body>
</html>
