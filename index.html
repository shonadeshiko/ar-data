<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ä½ç½®æƒ…å ±AR - åº¦æ•°æ³•ç‰ˆ</title>
  <style>
    body { 
      margin: 0; 
      overflow: hidden;
      font-family: sans-serif;
    }
    #video-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    #camera-feed {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #ar-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      pointer-events: none;
    }
    #info {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 12px;
      border-radius: 5px;
      z-index: 1000;
      font-size: 12px;
      max-width: 320px;
    }
    #start-button {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px 40px;
      font-size: 18px;
      background: #007AFF;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      z-index: 2000;
    }
    #controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 15px;
      border-radius: 10px;
      z-index: 1000;
      text-align: center;
    }
    #controls input {
      width: 150px;
      margin: 5px;
    }
    .status { font-size: 11px; margin: 3px 0; }
    .ok { color: #0f0; }
    .error { color: #f00; }
    .value { color: #4af; font-weight: bold; }
  </style>
</head>
<body>
  
  <button id="start-button">ARã‚’é–‹å§‹</button>
  
  <div id="video-container">
    <video id="camera-feed" autoplay playsinline></video>
  </div>
  
  <canvas id="ar-canvas"></canvas>
  
  <div id="info">
    <div><strong>ğŸ“± ä½ç½®æƒ…å ±ARï¼ˆåº¦æ•°æ³•ï¼‰</strong></div>
    <div id="camera-status" class="status">ğŸ“· ã‚«ãƒ¡ãƒ©: å¾…æ©Ÿä¸­</div>
    <div id="gps-status" class="status">ğŸ“ GPS: å¾…æ©Ÿä¸­</div>
    <div id="gyro-status" class="status">ğŸ§­ ã‚¸ãƒ£ã‚¤ãƒ­: å¾…æ©Ÿä¸­</div>
    <hr style="border-color: rgba(255,255,255,0.3); margin: 8px 0;">
    <div class="status">ä½ç½®: <span id="pos" class="value">--</span></div>
    <div class="status">å‘ã: <span id="heading" class="value">--</span>Â°</div>
    <div class="status">è¡¨ç¤ºç¯„å›²: <span id="range-display" class="value">0.003</span>Â° (â‰ˆ300m)</div>
    <div class="status">æœ€å¯„ã‚Š: <span id="nearest" class="value">--</span></div>
    <div class="status">è·é›¢: <span id="dist" class="value">--</span>Â° (<span id="dist-m">--</span>m)</div>
    <div class="status">è¡¨ç¤ºä¸­: <span id="visible-count" class="value">0</span>/11</div>
  </div>

  <div id="controls" style="display: none;">
    <div style="margin-bottom: 10px;"><strong>âš™ï¸ è¡¨ç¤ºç¯„å›²èª¿æ•´</strong></div>
    <div>
      <label>ç¯„å›²ï¼ˆåº¦ï¼‰:</label><br>
      <input type="range" id="range-slider" min="0.0001" max="0.01" step="0.0001" value="0.003">
      <span id="range-value">0.003</span>Â°
    </div>
    <div style="margin-top: 5px; font-size: 11px; color: #aaa;">
      0.001Â° â‰ˆ 100m | 0.003Â° â‰ˆ 300m | 0.01Â° â‰ˆ 1km
    </div>
  </div>

  <script>
    const posters = [
      {id: 1, lat: 35.720533, lon: 139.762619, ele: 2.31, color: '#FF0000'},
      {id: 2, lat: 35.720446, lon: 139.763486, ele: 2.72, color: '#FF7F00'},
      {id: 3, lat: 35.720987, lon: 139.764194, ele: 2.82, color: '#FFFF00'},
      {id: 4, lat: 35.720798, lon: 139.764362, ele: 3.08, color: '#7FFF00'},
      {id: 5, lat: 35.720655, lon: 139.764665, ele: 2.97, color: '#00FF00'},
      {id: 6, lat: 35.72042263035527,  lon: 139.76515295157975, ele: 2.6, color: '#00FF7F'},
      {id: 7, lat: 35.720311, lon: 139.765584, ele: 2.62, color: '#00FFFF'},
      {id: 8, lat: 35.720145, lon: 139.765950, ele: 2.7, color: '#007FFF'},
      {id: 9, lat: 35.719991, lon: 139.766207, ele: 2.73, color: '#0000FF'},
      {id: 10, lat: 35.719865, lon: 139.766525, ele: 2.89, color: '#7F00FF'},
      {id: 11, lat: 35.719580, lon: 139.766698, ele: 3.24, color: '#FF00FF'}
    ];

    let userLat = null;
    let userLon = null;
    let heading = 0;
    let canvas, ctx;
    let displayRange = 0.003; // è¡¨ç¤ºç¯„å›²ï¼ˆåº¦ï¼‰
    
    // ã“ã®åœ°ç‚¹ï¼ˆåŒ—ç·¯35.72åº¦ï¼‰ã§ã®1åº¦ã‚ãŸã‚Šã®è·é›¢
    const LAT_METER_PER_DEGREE = 111000; // ç·¯åº¦1åº¦ â‰ˆ 111km
    const LON_METER_PER_DEGREE = 90000;  // çµŒåº¦1åº¦ â‰ˆ 90km (cos(35.72Â°) â‰ˆ 0.81)
    
    // åº¦æ•°ã§è·é›¢è¨ˆç®—ï¼ˆå¹³é¢è¿‘ä¼¼ï¼‰
    function calculateDistanceDegree(lat1, lon1, lat2, lon2) {
      const dLat = lat2 - lat1;
      const dLon = lon2 - lon1;
      // å¹³é¢ç›´è§’åº§æ¨™çš„ãªè·é›¢ï¼ˆåº¦ï¼‰
      return Math.sqrt(dLat * dLat + dLon * dLon);
    }
    
    // åº¦ã‚’ãƒ¡ãƒ¼ãƒˆãƒ«ã«å¤‰æ›ï¼ˆæ¦‚ç®—ï¼‰
    function degreeToMeter(degree) {
      return degree * Math.sqrt(LAT_METER_PER_DEGREE * LON_METER_PER_DEGREE);
    }
    
    // æ–¹ä½è§’è¨ˆç®—ï¼ˆåŒ—ãŒ0åº¦ï¼‰
    function calculateBearing(lat1, lon1, lat2, lon2) {
      const dLon = lon2 - lon1;
      const dLat = lat2 - lat1;
      const Î¸ = Math.atan2(dLon, dLat);
      return (Î¸ * 180 / Math.PI + 360) % 360;
    }

    // ç¯„å›²ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼
    document.getElementById('range-slider').addEventListener('input', (e) => {
      displayRange = parseFloat(e.target.value);
      document.getElementById('range-value').textContent = displayRange.toFixed(4);
      document.getElementById('range-display').textContent = displayRange.toFixed(4);
      updateInfo();
    });

    // é–‹å§‹ãƒœã‚¿ãƒ³
    document.getElementById('start-button').addEventListener('click', async () => {
      document.getElementById('start-button').style.display = 'none';
      document.getElementById('controls').style.display = 'block';
      await startAR();
    });

    async function startAR() {
      // 1. ã‚«ãƒ¡ãƒ©èµ·å‹•
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: 1280, height: 720 }
        });
        const video = document.getElementById('camera-feed');
        video.srcObject = stream;
        document.getElementById('camera-status').innerHTML = 'ğŸ“· <span class="ok">ã‚«ãƒ¡ãƒ©: èµ·å‹•</span>';
        console.log('ã‚«ãƒ¡ãƒ©èµ·å‹•æˆåŠŸ');
      } catch (err) {
        document.getElementById('camera-status').innerHTML = `ğŸ“· <span class="error">ã‚«ãƒ¡ãƒ©: ${err.message}</span>`;
        console.error('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:', err);
        return;
      }

      // 2. CanvasåˆæœŸåŒ–
      canvas = document.getElementById('ar-canvas');
      ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      // 3. GPSé–‹å§‹
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition((position) => {
          userLat = position.coords.latitude;
          userLon = position.coords.longitude;
          document.getElementById('pos').textContent = 
            `${userLat.toFixed(6)}, ${userLon.toFixed(6)}`;
          document.getElementById('gps-status').innerHTML = 'ğŸ“ <span class="ok">GPS: å–å¾—ä¸­</span>';
          updateInfo();
        }, (err) => {
          document.getElementById('gps-status').innerHTML = `ğŸ“ <span class="error">GPS: ${err.message}</span>`;
        }, { enableHighAccuracy: true, maximumAge: 0 });
      }

      // 4. ã‚¸ãƒ£ã‚¤ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—
      if (window.DeviceOrientationEvent) {
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
          try {
            const permission = await DeviceOrientationEvent.requestPermission();
            if (permission === 'granted') {
              startOrientation();
            }
          } catch (err) {
            console.log('ã‚¸ãƒ£ã‚¤ãƒ­è¨±å¯ã‚¨ãƒ©ãƒ¼:', err);
            startOrientation();
          }
        } else {
          startOrientation();
        }
      }

      function startOrientation() {
        window.addEventListener('deviceorientationabsolute', (event) => {
          if (event.absolute && event.alpha !== null) {
            heading = 360 - event.alpha;
            document.getElementById('heading').textContent = Math.round(heading);
            document.getElementById('gyro-status').innerHTML = 'ğŸ§­ <span class="ok">ã‚¸ãƒ£ã‚¤ãƒ­: å‹•ä½œä¸­</span>';
          }
        });
        
        window.addEventListener('deviceorientation', (event) => {
          if (event.alpha !== null) {
            heading = 360 - event.alpha;
            document.getElementById('heading').textContent = Math.round(heading);
            document.getElementById('gyro-status').innerHTML = 'ğŸ§­ <span class="ok">ã‚¸ãƒ£ã‚¤ãƒ­: å‹•ä½œä¸­</span>';
          }
        });
      }

      // 5. æç”»ãƒ«ãƒ¼ãƒ—
      function draw() {
        if (!userLat || !userLon) {
          requestAnimationFrame(draw);
          return;
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const viewAngle = 60; // è¦–é‡è§’ï¼ˆåº¦ï¼‰

        posters.forEach(poster => {
          // åº¦æ•°ã§è·é›¢è¨ˆç®—
          const distanceDeg = calculateDistanceDegree(userLat, userLon, poster.lat, poster.lon);
          
          // è¡¨ç¤ºç¯„å›²å¤–ã¯æç”»ã—ãªã„
          if (distanceDeg > displayRange) return;

          const bearing = calculateBearing(userLat, userLon, poster.lat, poster.lon);
          const angleDiff = ((bearing - heading + 540) % 360) - 180;

          // è¦–é‡è§’å†…ã‹ãƒã‚§ãƒƒã‚¯
          if (Math.abs(angleDiff) < viewAngle) {
            const screenX = centerX + (angleDiff / viewAngle) * canvas.width;
            
            // è·é›¢ã«å¿œã˜ã¦ã‚µã‚¤ã‚ºã‚’èª¿æ•´ï¼ˆåº¦æ•°ãƒ™ãƒ¼ã‚¹ï¼‰
            const size = Math.max(40, 0.003 / distanceDeg * 150);
            const screenY = centerY - (size / 2);

            // ãƒã‚¹ã‚¿ãƒ¼ã‚’æç”»
            ctx.fillStyle = poster.color;
            ctx.fillRect(screenX - size/2, screenY - size/2, size, size * 1.5);
            
            // æ ç·š
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = 3;
            ctx.strokeRect(screenX - size/2, screenY - size/2, size, size * 1.5);

            // ç•ªå·
            ctx.fillStyle = '#FFFFFF';
            ctx.font = `bold ${size/2}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(poster.id, screenX, screenY);

            // è·é›¢è¡¨ç¤ºï¼ˆåº¦ã¨ãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
            ctx.font = `${size/4}px sans-serif`;
            const distanceM = degreeToMeter(distanceDeg);
            ctx.fillText(`${distanceM.toFixed(0)}m`, screenX, screenY + size);
          }
        });

        requestAnimationFrame(draw);
      }

      draw();
    }

    function updateInfo() {
      if (!userLat || !userLon) return;

      let nearest = null;
      let minDistance = Infinity;
      let visibleCount = 0;

      posters.forEach(poster => {
        const distanceDeg = calculateDistanceDegree(userLat, userLon, poster.lat, poster.lon);
        if (distanceDeg < minDistance) {
          minDistance = distanceDeg;
          nearest = poster;
        }
        if (distanceDeg < displayRange) visibleCount++;
      });

      if (nearest) {
        document.getElementById('nearest').textContent = `${nearest.id}ç•ª`;
        document.getElementById('dist').textContent = minDistance.toFixed(6);
        document.getElementById('dist-m').textContent = degreeToMeter(minDistance).toFixed(1);
      }
      document.getElementById('visible-count').textContent = visibleCount;
    }

    // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
    window.addEventListener('resize', () => {
      if (canvas) {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
    });
  </script>
</body>
</html>
