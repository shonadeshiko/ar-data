<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>AR ポスター配置シミュレーション - 文京区</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ar.js@2.2.2/aframe/build/aframe-ar-nft.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    #info {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 15px;
      border-radius: 5px;
      z-index: 1000;
      font-family: sans-serif;
      font-size: 14px;
      max-width: 350px;
    }
    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 20px;
      border-radius: 10px;
      z-index: 2000;
      font-family: sans-serif;
    }
    .info-row {
      margin: 5px 0;
      padding: 5px 0;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    .info-row:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>
  
  <div id="loading">GPS情報を取得中...</div>
  
  <div id="info">
    <div class="info-row">
      <strong>現在位置</strong><br>
      緯度: <span id="current-lat">--</span><br>
      経度: <span id="current-lon">--</span>
    </div>
    <div class="info-row">
      <strong>最寄りポスター:</strong> <span id="nearest-poster">--</span><br>
      <strong>距離:</strong> <span id="distance">--</span>m
    </div>
    <div class="info-row">
      <strong>表示範囲内:</strong> <span id="visible-count">0</span> / 11箇所
    </div>
  </div>

  <a-scene
    vr-mode-ui="enabled: false"
    arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
    renderer="logarithmicDepthBuffer: true; precision: medium;"
    embedded
    gesture-detector>
    
    <!-- 画像アセット（1枚のみ） -->
    <a-assets>
      <img id="poster" src="poster.jpg" crossorigin="anonymous">
    </a-assets>
    
    <a-camera gps-projected-camera rotation-reader></a-camera>

    <!-- ポスター1: 標高2.31m -->
    <a-entity
      gps-projected-entity-place="latitude: 35.720533; longitude: 139.762619;"
      look-at="[gps-projected-camera]">
      <a-plane 
        material="src: #poster; transparent: true; opacity: 1;"
        width="2" 
        height="3"
        position="0 2.31 0">
      </a-plane>
      <a-text 
        value="1" 
        position="0 0.51 0.01" 
        align="center" 
        color="#FFFF00"
        width="3"
        background="color: rgba(0,0,0,0.7); opacity: 0.9;">
      </a-text>
    </a-entity>

    <!-- ポスター2: 標高2.72m -->
    <a-entity
      gps-projected-entity-place="latitude: 35.720446; longitude: 139.763486;"
      look-at="[gps-projected-camera]">
      <a-plane 
        material="src: #poster; transparent: true; opacity: 1;"
        width="2" 
        height="3"
        position="0 2.72 0">
      </a-plane>
      <a-text 
        value="2" 
        position="0 0.92 0.01" 
        align="center" 
        color="#FFFF00"
        width="3"
        background="color: rgba(0,0,0,0.7); opacity: 0.9;">
      </a-text>
    </a-entity>

    <!-- ポスター3: 標高2.82m -->
    <a-entity
      gps-projected-entity-place="latitude: 35.720987; longitude: 139.764194;"
      look-at="[gps-projected-camera]">
      <a-plane 
        material="src: #poster; transparent: true; opacity: 1;"
        width="2" 
        height="3"
        position="0 2.82 0">
      </a-plane>
      <a-text 
        value="3" 
        position="0 1.02 0.01" 
        align="center" 
        color="#FFFF00"
        width="3"
        background="color: rgba(0,0,0,0.7); opacity: 0.9;">
      </a-text>
    </a-entity>

    <!-- ポスター4: 標高3.08m -->
    <a-entity
      gps-projected-entity-place="latitude: 35.720798; longitude: 139.764362;"
      look-at="[gps-projected-camera]">
      <a-plane 
        material="src: #poster; transparent: true; opacity: 1;"
        width="2" 
        height="3"
        position="0 3.08 0">
      </a-plane>
      <a-text 
        value="4" 
        position="0 1.28 0.01" 
        align="center" 
        color="#FFFF00"
        width="3"
        background="color: rgba(0,0,0,0.7); opacity: 0.9;">
      </a-text>
    </a-entity>

    <!-- ポスター5: 標高2.97m -->
    <a-entity
      gps-projected-entity-place="latitude: 35.720655; longitude: 139.764665;"
      look-at="[gps-projected-camera]">
      <a-plane 
        material="src: #poster; transparent: true; opacity: 1;"
        width="2" 
        height="3"
        position="0 2.97 0">
      </a-plane>
      <a-text 
        value="5" 
        position="0 1.17 0.01" 
        align="center" 
        color="#FFFF00"
        width="3"
        background="color: rgba(0,0,0,0.7); opacity: 0.9;">
      </a-text>
    </a-entity>

    <!-- ポスター6: 標高2.6m -->
    <a-entity
      gps-projected-entity-place="latitude: 35.720462; longitude: 139.765279;"
      look-at="[gps-projected-camera]">
      <a-plane 
        material="src: #poster; transparent: true; opacity: 1;"
        width="2" 
        height="3"
        position="0 2.6 0">
      </a-plane>
      <a-text 
        value="6" 
        position="0 0.80 0.01" 
        align="center" 
        color="#FFFF00"
        width="3"
        background="color: rgba(0,0,0,0.7); opacity: 0.9;">
      </a-text>
    </a-entity>

    <!-- ポスター7: 標高2.62m -->
    <a-entity
      gps-projected-entity-place="latitude: 35.720311; longitude: 139.765584;"
      look-at="[gps-projected-camera]">
      <a-plane 
        material="src: #poster; transparent: true; opacity: 1;"
        width="2" 
        height="3"
        position="0 2.62 0">
      </a-plane>
      <a-text 
        value="7" 
        position="0 0.82 0.01" 
        align="center" 
        color="#FFFF00"
        width="3"
        background="color: rgba(0,0,0,0.7); opacity: 0.9;">
      </a-text>
    </a-entity>

    <!-- ポスター8: 標高2.7m -->
    <a-entity
      gps-projected-entity-place="latitude: 35.720145; longitude: 139.765950;"
      look-at="[gps-projected-camera]">
      <a-plane 
        material="src: #poster; transparent: true; opacity: 1;"
        width="2" 
        height="3"
        position="0 2.7 0">
      </a-plane>
      <a-text 
        value="8" 
        position="0 0.90 0.01" 
        align="center" 
        color="#FFFF00"
        width="3"
        background="color: rgba(0,0,0,0.7); opacity: 0.9;">
      </a-text>
    </a-entity>

    <!-- ポスター9: 標高2.73m -->
    <a-entity
      gps-projected-entity-place="latitude: 35.719991; longitude: 139.766207;"
      look-at="[gps-projected-camera]">
      <a-plane 
        material="src: #poster; transparent: true; opacity: 1;"
        width="2" 
        height="3"
        position="0 2.73 0">
      </a-plane>
      <a-text 
        value="9" 
        position="0 0.93 0.01" 
        align="center" 
        color="#FFFF00"
        width="3"
        background="color: rgba(0,0,0,0.7); opacity: 0.9;">
      </a-text>
    </a-entity>

    <!-- ポスター10: 標高2.89m -->
    <a-entity
      gps-projected-entity-place="latitude: 35.719865; longitude: 139.766525;"
      look-at="[gps-projected-camera]">
      <a-plane 
        material="src: #poster; transparent: true; opacity: 1;"
        width="2" 
        height="3"
        position="0 2.89 0">
      </a-plane>
      <a-text 
        value="10" 
        position="0 1.09 0.01" 
        align="center" 
        color="#FFFF00"
        width="3"
        background="color: rgba(0,0,0,0.7); opacity: 0.9;">
      </a-text>
    </a-entity>

    <!-- ポスター11: 標高3.24m -->
    <a-entity
      gps-projected-entity-place="latitude: 35.719580; longitude: 139.766698;"
      look-at="[gps-projected-camera]">
      <a-plane 
        material="src: #poster; transparent: true; opacity: 1;"
        width="2" 
        height="3"
        position="0 3.24 0">
      </a-plane>
      <a-text 
        value="11" 
        position="0 1.44 0.01" 
        align="center" 
        color="#FFFF00"
        width="3"
        background="color: rgba(0,0,0,0.7); opacity: 0.9;">
      </a-text>
    </a-entity>

  </a-scene>

  <script>
    // 位置情報データ（文京区周辺に移動）
    const posters = [
      {id: 1, lat: 35.720533, lon: 139.762619, ele: 2.31},
      {id: 2, lat: 35.720446, lon: 139.763486, ele: 2.72},
      {id: 3, lat: 35.720987, lon: 139.764194, ele: 2.82},
      {id: 4, lat: 35.720798, lon: 139.764362, ele: 3.08},
      {id: 5, lat: 35.720655, lon: 139.764665, ele: 2.97},
      {id: 6, lat: 35.720462, lon: 139.765279, ele: 2.6},
      {id: 7, lat: 35.720311, lon: 139.765584, ele: 2.62},
      {id: 8, lat: 35.720145, lon: 139.765950, ele: 2.7},
      {id: 9, lat: 35.719991, lon: 139.766207, ele: 2.73},
      {id: 10, lat: 35.719865, lon: 139.766525, ele: 2.89},
      {id: 11, lat: 35.719580, lon: 139.766698, ele: 3.24}
    ];

    // 2点間の距離を計算（Haversine formula）
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // 地球の半径（メートル）
      const φ1 = lat1 * Math.PI / 180;
      const φ2 = lat2 * Math.PI / 180;
      const Δφ = (lat2 - lat1) * Math.PI / 180;
      const Δλ = (lon2 - lon1) * Math.PI / 180;

      const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c; // メートル
    }

    // GPS位置情報の監視
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition((position) => {
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;
        
        document.getElementById('current-lat').textContent = userLat.toFixed(6);
        document.getElementById('current-lon').textContent = userLon.toFixed(6);
        document.getElementById('loading').style.display = 'none';

        let nearest = null;
        let minDistance = Infinity;
        let visibleCount = 0;

        posters.forEach(poster => {
          const distance = calculateDistance(userLat, userLon, poster.lat, poster.lon);
          if (distance < minDistance) {
            minDistance = distance;
            nearest = poster;
          }
          // 300m以内を表示範囲とする
          if (distance < 300) {
            visibleCount++;
          }
        });

        if (nearest) {
          document.getElementById('nearest-poster').textContent = `${nearest.id}番 (標高${nearest.ele}m)`;
          document.getElementById('distance').textContent = minDistance.toFixed(1);
        }
        
        document.getElementById('visible-count').textContent = visibleCount;
      }, (error) => {
        console.error('GPS error:', error);
        let errorMsg = 'GPS取得エラー: ';
        switch(error.code) {
          case error.PERMISSION_DENIED:
            errorMsg += '位置情報の許可が拒否されました';
            break;
          case error.POSITION_UNAVAILABLE:
            errorMsg += '位置情報が利用できません';
            break;
          case error.TIMEOUT:
            errorMsg += 'タイムアウトしました';
            break;
          default:
            errorMsg += error.message;
        }
        document.getElementById('loading').textContent = errorMsg;
      }, {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 27000
      });
    } else {
      document.getElementById('loading').textContent = 'このブラウザはGPSに対応していません';
    }

    // シーン読み込み完了の確認
    document.querySelector('a-scene').addEventListener('loaded', function () {
      console.log('ARシーンが読み込まれました');
    });
  </script>
</body>
</html>
