<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ä½ç½®å›ºå®šARãƒã‚¹ã‚¿ãƒ¼</title>
  <style>
    body { 
      margin: 0; 
      overflow: hidden;
      font-family: sans-serif;
    }
    #video-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    #camera-feed {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #ar-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      pointer-events: none;
    }
    #debug-info {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
      font-size: 11px;
      font-family: monospace;
      max-width: 90%;
    }
    #permission-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.95);
      color: white;
      padding: 30px;
      border-radius: 15px;
      z-index: 2000;
      text-align: center;
      display: none;
    }
    .button {
      padding: 15px 30px;
      font-size: 16px;
      background: #007AFF;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin: 10px;
    }
    .button:active {
      background: #0051D5;
    }
    .ok { color: #0f0; }
    .warn { color: #ff0; }
    .error { color: #f00; }
  </style>
</head>
<body>
  
  <div id="permission-panel">
    <h2>ğŸ“± ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯</h2>
    <p>ARã‚’ä½¿ã†ã«ã¯ã€ã‚«ãƒ¡ãƒ©ã€GPSã€<br>ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒå¿…è¦ã§ã™</p>
    <button class="button" onclick="startAR()">ARã‚’é–‹å§‹</button>
  </div>
  
  <div id="video-container">
    <video id="camera-feed" autoplay playsinline></video>
  </div>
  
  <canvas id="ar-canvas"></canvas>
  
  <div id="debug-info">
    <div><strong>ğŸ“± ãƒ‡ãƒãƒƒã‚°æƒ…å ±</strong></div>
    <div>GPS: <span id="gps-status">å¾…æ©Ÿä¸­</span></div>
    <div>ä½ç½®: <span id="position">--</span></div>
    <div>æ–¹ä½: <span id="heading">--</span>Â°</div>
    <div>ç”»åƒ: <span id="image-status">èª­è¾¼ä¸­</span></div>
    <div>è¡¨ç¤ºç¯„å›²: 50m</div>
    <div>è¡¨ç¤ºä¸­: <span id="visible-count" class="warn">0</span>å€‹</div>
    <div>æœ€å¯„ã‚Š: <span id="nearest">--</span></div>
  </div>

  <script>
    // 11ç®‡æ‰€ã®ãƒã‚¹ã‚¿ãƒ¼åº§æ¨™
    const posters = [
      {id: 1, lat: 35.720533, lon: 139.762619, height: 2.31},
      {id: 2, lat: 35.720446, lon: 139.763486, height: 2.72},
      {id: 3, lat: 35.720987, lon: 139.764194, height: 2.82},
      {id: 4, lat: 35.720798, lon: 139.764362, height: 3.08},
      {id: 5, lat: 35.720655, lon: 139.764665, height: 2.97},
      {id: 6, lat: 35.720462, lon: 139.765279, height: 2.6},
      {id: 7, lat: 35.720311, lon: 139.765584, height: 2.62},
      {id: 8, lat: 35.720145, lon: 139.765950, height: 2.7},
      {id: 9, lat: 35.719991, lon: 139.766207, height: 2.73},
      {id: 10, lat: 35.719865, lon: 139.766525, height: 2.89},
      {id: 11, lat: 35.719580, lon: 139.766698, height: 3.24}
    ];

    let userLat = null;
    let userLon = null;
    let heading = 0;
    let canvas, ctx;
    let posterImage = null;
    let headingAvailable = false;
    
    // è¡¨ç¤ºè·é›¢ï¼ˆç´„50mä»¥å†…ï¼‰
    const DISPLAY_RANGE = 0.0005;
    
    // ã‚«ãƒ¡ãƒ©ã®è¦–é‡è§’
    const CAMERA_FOV = 70;
    
    // ãƒã‚¹ã‚¿ãƒ¼ç”»åƒã‚’èª­ã¿è¾¼ã¿
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => {
      posterImage = img;
      document.getElementById('image-status').innerHTML = '<span class="ok">OK</span>';
    };
    img.onerror = () => {
      document.getElementById('image-status').innerHTML = '<span class="error">ã‚¨ãƒ©ãƒ¼</span>';
    };
    img.src = 'poster.jpg';
    
    // è·é›¢è¨ˆç®—
    function calculateDistanceDegree(lat1, lon1, lat2, lon2) {
      const dLat = lat2 - lat1;
      const dLon = lon2 - lon1;
      return Math.sqrt(dLat * dLat + dLon * dLon);
    }
    
    function degreeToMeter(degree) {
      return degree * 100000;
    }
    
    // æ–¹ä½è§’è¨ˆç®—
    function calculateBearing(lat1, lon1, lat2, lon2) {
      const dLon = lon2 - lon1;
      const dLat = lat2 - lat1;
      const Î¸ = Math.atan2(dLon, dLat);
      return (Î¸ * 180 / Math.PI + 360) % 360;
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è¨±å¯ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
    window.addEventListener('load', () => {
      document.getElementById('permission-panel').style.display = 'block';
    });

    async function startAR() {
      document.getElementById('permission-panel').style.display = 'none';
      
      // ã‚«ãƒ¡ãƒ©èµ·å‹•
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: 1280, height: 720 }
        });
        const video = document.getElementById('camera-feed');
        video.srcObject = stream;
        console.log('âœ“ ã‚«ãƒ¡ãƒ©èµ·å‹•');
      } catch (err) {
        alert('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ' + err.message);
        return;
      }

      // CanvasåˆæœŸåŒ–
      canvas = document.getElementById('ar-canvas');
      ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      // GPSé–‹å§‹
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition((position) => {
          userLat = position.coords.latitude;
          userLon = position.coords.longitude;
          document.getElementById('gps-status').innerHTML = '<span class="ok">OK</span>';
          document.getElementById('position').textContent = 
            `${userLat.toFixed(6)}, ${userLon.toFixed(6)}`;
          updateDebugInfo();
        }, (err) => {
          document.getElementById('gps-status').innerHTML = '<span class="error">ã‚¨ãƒ©ãƒ¼</span>';
          console.error('GPS error:', err);
        }, { enableHighAccuracy: true, maximumAge: 0 });
      }

      // ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ãƒ³ã‚µãƒ¼ï¼ˆã‚¸ãƒ£ã‚¤ãƒ­ï¼‰ã®è¨±å¯ã‚’è¦æ±‚
      if (typeof DeviceOrientationEvent !== 'undefined' && 
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        // iOS 13+ ã®å ´åˆ
        try {
          const permission = await DeviceOrientationEvent.requestPermission();
          if (permission === 'granted') {
            console.log('âœ“ ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ãƒ³ã‚µãƒ¼è¨±å¯');
            startOrientation();
          } else {
            console.log('âœ— ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ãƒ³ã‚µãƒ¼æ‹’å¦');
            alert('æ–¹ä½æƒ…å ±ã‚’ä½¿ã†ã«ã¯ã€ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚\n\nè¨­å®š > Safari > ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã¨ç”»é¢ã®å‘ãã®ã‚¢ã‚¯ã‚»ã‚¹ ã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„ã€‚');
          }
        } catch (err) {
          console.error('Permission error:', err);
          alert('ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nè¨­å®š > Safari > ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã¨ç”»é¢ã®å‘ãã®ã‚¢ã‚¯ã‚»ã‚¹ ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
      } else {
        // Android ãªã©ã®å ´åˆ
        startOrientation();
      }

      function startOrientation() {
        // ãƒ‡ãƒã‚¤ã‚¹ã®çµ¶å¯¾æ–¹ä½ã‚’å–å¾—
        window.addEventListener('deviceorientationabsolute', (event) => {
          if (event.absolute && event.alpha !== null) {
            heading = 360 - event.alpha;
            headingAvailable = true;
            document.getElementById('heading').innerHTML = 
              `<span class="ok">${Math.round(heading)}</span>`;
          }
        });
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        window.addEventListener('deviceorientation', (event) => {
          if (event.alpha !== null && !headingAvailable) {
            heading = 360 - event.alpha;
            document.getElementById('heading').innerHTML = 
              `<span class="warn">${Math.round(heading)}</span>`;
          }
        });
        
        // 5ç§’çµŒã£ã¦ã‚‚æ–¹ä½ãŒå–å¾—ã§ããªã„å ´åˆã®è­¦å‘Š
        setTimeout(() => {
          if (!headingAvailable && heading === 0) {
            document.getElementById('heading').innerHTML = '<span class="error">å–å¾—å¤±æ•—</span>';
            alert('âš ï¸ æ–¹ä½æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚\n\niPhoneè¨­å®š:\nè¨­å®š > Safari > ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã¨ç”»é¢ã®å‘ãã®ã‚¢ã‚¯ã‚»ã‚¹\nã‚’ã‚ªãƒ³ã«ã—ã¦ãã ã•ã„ã€‚');
          }
        }, 5000);
      }

      // æç”»ãƒ«ãƒ¼ãƒ—
      function draw() {
        if (!userLat || !userLon || !posterImage) {
          requestAnimationFrame(draw);
          return;
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        let visibleCount = 0;

        // å…¨ã¦ã®ãƒã‚¹ã‚¿ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
        posters.forEach(poster => {
          const distanceDeg = calculateDistanceDegree(userLat, userLon, poster.lat, poster.lon);
          
          // è¡¨ç¤ºè·é›¢å†…ã‹ãƒã‚§ãƒƒã‚¯
          if (distanceDeg > DISPLAY_RANGE) return;
          
          const bearing = calculateBearing(userLat, userLon, poster.lat, poster.lon);
          
          // ã‚¹ãƒãƒ›ã®å‘ãã¨ãƒã‚¹ã‚¿ãƒ¼ã®æ–¹è§’ã®å·®ã‚’è¨ˆç®—
          let angleDiff = bearing - heading;
          if (angleDiff > 180) angleDiff -= 360;
          if (angleDiff < -180) angleDiff += 360;

          // ã‚«ãƒ¡ãƒ©ã®è¦–é‡è§’å†…ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          const halfFOV = CAMERA_FOV / 2;
          if (Math.abs(angleDiff) < halfFOV) {
            visibleCount++;
            
            // ç”»é¢ä¸Šã®åº§æ¨™ã‚’è¨ˆç®—
            const screenX = centerX + (angleDiff / halfFOV) * (canvas.width / 2);
            
            // è·é›¢ã«å¿œã˜ãŸã‚¹ã‚±ãƒ¼ãƒ«
            const minScale = 0.5;
            const maxScale = 3.0;
            const scale = Math.max(minScale, Math.min(maxScale, (DISPLAY_RANGE * 0.8) / distanceDeg));
            
            // ãƒã‚¹ã‚¿ãƒ¼ã‚µã‚¤ã‚º
            const posterWidth = 150 * scale;
            const posterHeight = 225 * scale;
            
            // é«˜ã•ã®è¨ˆç®—
            const eyeHeight = 1.6;
            const posterCenterHeight = poster.height;
            const distanceM = degreeToMeter(distanceDeg);
            const heightDiff = posterCenterHeight - eyeHeight;
            const verticalAngle = Math.atan2(heightDiff, distanceM) * 180 / Math.PI;
            const screenY = centerY - (verticalAngle / 30) * canvas.height / 2;
            
            // ãƒã‚¹ã‚¿ãƒ¼ç”»åƒã‚’æç”»
            ctx.save();
            const opacity = Math.max(0.8, Math.min(1.0, scale / 2.0));
            ctx.globalAlpha = opacity;
            
            ctx.drawImage(posterImage, 
              screenX - posterWidth / 2, 
              screenY - posterHeight / 2, 
              posterWidth, 
              posterHeight
            );
            
            // ãƒ‡ãƒãƒƒã‚°ç”¨ã®ç•ªå·ã¨è·é›¢
            ctx.globalAlpha = 1.0;
            ctx.fillStyle = '#FFFF00';
            ctx.font = 'bold 20px sans-serif';
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 4;
            const text = `${poster.id} (${Math.round(distanceM)}m)`;
            ctx.strokeText(text, screenX, screenY - posterHeight/2 - 10);
            ctx.fillText(text, screenX, screenY - posterHeight/2 - 10);
            
            ctx.restore();
          }
        });

        // è¡¨ç¤ºä¸­ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
        const countElem = document.getElementById('visible-count');
        countElem.textContent = visibleCount;
        countElem.className = visibleCount > 0 ? 'ok' : 'warn';

        requestAnimationFrame(draw);
      }

      draw();
    }

    function updateDebugInfo() {
      if (!userLat || !userLon) return;

      let nearest = null;
      let minDistance = Infinity;

      posters.forEach(poster => {
        const distanceDeg = calculateDistanceDegree(userLat, userLon, poster.lat, poster.lon);
        if (distanceDeg < minDistance) {
          minDistance = distanceDeg;
          nearest = poster;
        }
      });

      if (nearest) {
        const distanceM = degreeToMeter(minDistance);
        const inRange = minDistance < DISPLAY_RANGE;
        document.getElementById('nearest').innerHTML = 
          `ãƒã‚¹ã‚¿ãƒ¼${nearest.id} - ${distanceM.toFixed(0)}m <span class="${inRange ? 'ok' : 'warn'}">(${inRange ? 'ç¯„å›²å†…' : 'ç¯„å›²å¤–'})</span>`;
      }
    }

    // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
    window.addEventListener('resize', () => {
      if (canvas) {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
    });
  </script>
</body>
</html>
