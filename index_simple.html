<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ポスターAR - 簡易版</title>
  <style>
    body { 
      margin: 0; 
      overflow: hidden;
      font-family: sans-serif;
    }
    #video-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    #camera-feed {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #ar-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      pointer-events: none;
    }
    #info {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      z-index: 1000;
      font-size: 14px;
      text-align: center;
      min-width: 200px;
    }
    #start-button {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px 40px;
      font-size: 18px;
      background: #007AFF;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      z-index: 2000;
    }
    .highlight { color: #0f0; font-weight: bold; }
  </style>
</head>
<body>
  
  <button id="start-button">ARを開始</button>
  
  <div id="video-container">
    <video id="camera-feed" autoplay playsinline></video>
  </div>
  
  <canvas id="ar-canvas"></canvas>
  
  <div id="info">
    <div>表示中: <span id="visible-count" class="highlight">0</span> 個のポスター</div>
    <div style="font-size: 12px; margin-top: 5px;">スマホを360°回してポスターを探してください</div>
  </div>

  <script>
    const posters = [
      {id: 1, lat: 35.720533, lon: 139.762619},
      {id: 2, lat: 35.720446, lon: 139.763486},
      {id: 3, lat: 35.720987, lon: 139.764194},
      {id: 4, lat: 35.720798, lon: 139.764362},
      {id: 5, lat: 35.720655, lon: 139.764665},
      {id: 6, lat: 35.720462, lon: 139.765279},
      {id: 7, lat: 35.720311, lon: 139.765584},
      {id: 8, lat: 35.720145, lon: 139.765950},
      {id: 9, lat: 35.719991, lon: 139.766207},
      {id: 10, lat: 35.719865, lon: 139.766525},
      {id: 11, lat: 35.719580, lon: 139.766698}
    ];

    let userLat = null;
    let userLon = null;
    let heading = 0;
    let canvas, ctx;
    let posterImage = null;
    const displayRange = 0.005; // 500m以内
    
    // 画像を事前読み込み
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => {
      posterImage = img;
      console.log('ポスター画像読み込み完了');
    };
    img.onerror = () => {
      console.error('ポスター画像読み込み失敗');
    };
    img.src = 'poster.jpg';
    
    function calculateDistanceDegree(lat1, lon1, lat2, lon2) {
      const dLat = lat2 - lat1;
      const dLon = lon2 - lon1;
      return Math.sqrt(dLat * dLat + dLon * dLon);
    }
    
    function calculateBearing(lat1, lon1, lat2, lon2) {
      const dLon = lon2 - lon1;
      const dLat = lat2 - lat1;
      const θ = Math.atan2(dLon, dLat);
      return (θ * 180 / Math.PI + 360) % 360;
    }

    document.getElementById('start-button').addEventListener('click', async () => {
      document.getElementById('start-button').style.display = 'none';
      await startAR();
    });

    async function startAR() {
      // カメラ起動
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: 1280, height: 720 }
        });
        const video = document.getElementById('camera-feed');
        video.srcObject = stream;
        console.log('カメラ起動成功');
      } catch (err) {
        alert('カメラエラー: ' + err.message);
        return;
      }

      // Canvas初期化
      canvas = document.getElementById('ar-canvas');
      ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      // GPS開始
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition((position) => {
          userLat = position.coords.latitude;
          userLon = position.coords.longitude;
          console.log('GPS:', userLat.toFixed(6), userLon.toFixed(6));
        }, null, { enableHighAccuracy: true, maximumAge: 0 });
      }

      // ジャイロスコープ（方位）
      if (window.DeviceOrientationEvent) {
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
          DeviceOrientationEvent.requestPermission().then(permission => {
            if (permission === 'granted') startOrientation();
          }).catch(() => startOrientation());
        } else {
          startOrientation();
        }
      }

      function startOrientation() {
        // デバイスの絶対方位を取得
        window.addEventListener('deviceorientationabsolute', (event) => {
          if (event.absolute && event.alpha !== null) {
            heading = 360 - event.alpha; // 北を0度に
          }
        });
        
        // フォールバック
        window.addEventListener('deviceorientation', (event) => {
          if (event.alpha !== null) {
            heading = 360 - event.alpha;
          }
        });
      }

      // 描画ループ
      function draw() {
        if (!userLat || !userLon || !posterImage) {
          requestAnimationFrame(draw);
          return;
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const viewAngle = 90; // 視野角を広く（90度）

        let visibleCount = 0;

        posters.forEach(poster => {
          const distanceDeg = calculateDistanceDegree(userLat, userLon, poster.lat, poster.lon);
          
          // 表示範囲外はスキップ
          if (distanceDeg > displayRange) return;

          const bearing = calculateBearing(userLat, userLon, poster.lat, poster.lon);
          
          // スマホの向きとポスターの方角の差
          let angleDiff = bearing - heading;
          // -180〜180の範囲に正規化
          if (angleDiff > 180) angleDiff -= 360;
          if (angleDiff < -180) angleDiff += 360;

          // 視野角内にあるかチェック
          if (Math.abs(angleDiff) < viewAngle) {
            visibleCount++;

            // 画面上のX位置（-90°〜+90°を画面幅にマッピング）
            const screenX = centerX + (angleDiff / viewAngle) * canvas.width;
            
            // 距離に応じたサイズ（近いほど大きく）
            const baseSize = 200; // 基本サイズ
            const scale = Math.max(0.3, Math.min(2.0, 0.005 / distanceDeg));
            const width = baseSize * scale;
            const height = width * 1.5; // 縦長（2:3比率）
            
            // Y位置（画面中央）
            const screenY = centerY - height / 2;

            // ポスター画像を描画
            try {
              ctx.drawImage(posterImage, 
                screenX - width/2, 
                screenY, 
                width, 
                height
              );

              // 枠線
              ctx.strokeStyle = '#FFFF00';
              ctx.lineWidth = 4;
              ctx.strokeRect(screenX - width/2, screenY, width, height);

              // 番号表示
              ctx.fillStyle = '#FFFF00';
              ctx.font = 'bold 24px sans-serif';
              ctx.textAlign = 'center';
              ctx.strokeStyle = '#000000';
              ctx.lineWidth = 3;
              ctx.strokeText(`${poster.id}`, screenX, screenY - 15);
              ctx.fillText(`${poster.id}`, screenX, screenY - 15);

              // 距離表示
              const distanceM = Math.round(distanceDeg * 100000);
              ctx.font = '16px sans-serif';
              ctx.strokeText(`${distanceM}m`, screenX, screenY + height + 20);
              ctx.fillText(`${distanceM}m`, screenX, screenY + height + 20);

            } catch (e) {
              console.error('描画エラー:', e);
            }
          }
        });

        document.getElementById('visible-count').textContent = visibleCount;
        requestAnimationFrame(draw);
      }

      draw();
    }

    window.addEventListener('resize', () => {
      if (canvas) {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
    });
  </script>
</body>
</html>
